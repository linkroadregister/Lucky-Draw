<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lucky Draw ‚Äì 6 Digits (Production)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--gold:#ffd166;--bg1:#b2070b;--bg2:#6c0404}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#fff;min-height:100vh;display:flex;flex-direction:column;
      background:
        radial-gradient(circle at 50% 40%, rgba(255,255,255,.07), rgba(255,255,255,0) 36%),
        repeating-conic-gradient(from 0deg, rgba(255,255,255,.08) 0 10deg, rgba(0,0,0,0) 10deg 20deg),
        radial-gradient(circle at 50% 40%, var(--bg1) 0%, #8d0606 60%, var(--bg2) 100%);
      background-blend-mode: screen, soft-light, normal}
    .title{background:#fff;color:#111827;border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.2)}
    .digit{width:clamp(60px,9vw,110px);height:clamp(86px,14vw,140px);background:#fff;color:#111827;border-radius:16px;display:grid;place-items:center;font-weight:900;font-size:clamp(36px,7vw,80px);box-shadow:0 10px 22px rgba(0,0,0,.25), inset 0 -4px 0 #f2f2f2;border:4px solid #f6e1a2}
    .digit.locked{outline:3px solid var(--gold);box-shadow:0 0 0 3px rgba(255,209,102,.35),0 10px 22px rgba(0,0,0,.25)}
    .btn{transition:transform .06s ease, box-shadow .2s}.btn:active{transform:translateY(1px)}
    .btn-primary{background:#fff;color:#7a0303;font-weight:800}
    .btn-ghost{background:transparent;border:1px solid #ffffff40}
    .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-bg.show{display:flex}
    .modal{background:#7a0202;color:#fff;width:min(92vw,900px);border-radius:16px}
    .list{max-height:45vh;overflow:auto}
    select,input,textarea{color:#111827}
    /* Fullscreen cleanup */
    .fs-mode .hide-in-fs{display:none !important}
    .fs-mode .show-in-fs{display:block !important}
    .show-in-fs{display:none}
    .show-inline{display:inline}
    .fs-mode main{padding:0}
    .fs-mode #drawStage{max-width:min(1600px,96vw);gap:clamp(8px,2vw,24px)}
    .fs-mode #digitsRow{gap:clamp(10px,2.5vw,28px)}
    .fs-mode .digit{width:clamp(110px,14vw,220px);height:clamp(150px,20vw,260px);font-size:clamp(72px,12vw,180px);border-width:6px}
    .fs-mode #fsPrizeRemain{display:none}
    .fs-mode .modal-bg{display:none!important}
  </style>
</head>
<body>
  <header class="px-4 sm:px-8 py-4 flex items-center justify-between gap-3 hide-in-fs">
    <div class="title px-4 py-1 text-2xl font-extrabold">Lucky Draw</div>
    <nav class="flex gap-2">
      <button id="tabRegister" class="px-3 py-2 rounded-md bg-white/10">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
      <button id="tabDraw" class="px-3 py-2 rounded-md bg-[color:var(--gold)] text-black font-semibold">‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
      <button id="btnFullscreen" class="px-3 py-2 rounded-md btn-ghost">‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‚§¢</button>
    </nav>
  </header>

  <main class="flex-1 px-4 sm:px-8 pb-10">
    <!-- DRAW (stage) -->
    <section id="panelDraw" class="grid place-items-center">
      <div id="drawStage" class="w-full max-w-6xl grid gap-5 text-center">
        <div id="digitsRow" class="flex justify-center gap-3 sm:gap-5 flex-wrap">
          <div class="digit" id="d0">0</div>
          <div class="digit" id="d1">0</div>
          <div class="digit" id="d2">0</div>
          <div class="digit" id="d3">0</div>
          <div class="digit" id="d4">0</div>
          <div class="digit" id="d5">0</div>
        </div>

        <!-- Prize selector (normal) -->
        <div class="hide-in-fs flex flex-wrap justify-center items-center gap-3">
          <div class="text-base sm:text-lg">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</div>
          <select id="quickPrize" class="rounded px-3 py-2 min-w-[300px] bg-white text-black font-semibold"></select>
          <div class="text-sm opacity-90">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <span id="quickRemain">-</span></div>
        </div>
        <!-- Prize view (fullscreen) -->
        <div id="fsPrizeView" class="show-in-fs text-xl sm:text-2xl font-semibold">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: <span id="fsPrizeName" class="text-[color:var(--gold)]"></span> <span id="fsPrizeRemain" class="opacity-90 text-base"></span></div>

        <div id="drawNumberLine" class="hide-in-fs text-lg sm:text-2xl">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ: <span id="drawNumber" class="text-[color:var(--gold)] font-extrabold">000000</span></div>

        <div class="hide-in-fs flex flex-wrap justify-center gap-3">
          <button id="btnStart" class="btn btn-primary px-6 py-3 rounded-lg text-lg">üé∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∏‡πà‡∏°</button>
          <button id="btnManagePrize" class="btn btn-ghost px-6 py-3 rounded-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button>
          <button id="btnResetWinners" class="btn btn-ghost px-6 py-3 rounded-lg">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</button>
          <button id="btnExportWinners" class="btn btn-ghost px-6 py-3 rounded-lg">Export ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞ CSV</button>
        </div>

        <div class="hide-in-fs w-full max-w-4xl mt-2">
          <h3 class="font-bold mb-2">‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</h3>
          <ol id="winnerList" class="grid gap-2 text-sm list"></ol>
        </div>
      </div>
    </section>

    <!-- REGISTER (Names) -->
    <section id="panelRegister" class="hidden">
      <div class="w-full max-w-6xl mx-auto grid gap-4">
        <div class="bg-white/10 p-4 rounded-xl">
          <div class="flex gap-2 mb-3">
            <button id="tabNamesList" class="px-3 py-2 rounded bg-white/20 font-semibold">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            <button id="tabNamesAdd" class="px-3 py-2 rounded bg-white/10">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
          </div>
          <!-- Add -->
          <div id="namesAdd" class="hidden grid gap-3">
            <div class="grid sm:grid-cols-[160px_1fr_auto] gap-2 items-center">
              <input id="regNumber" maxlength="6" placeholder="000000" class="rounded px-3 py-2 text-black w-[140px]" />
              <input id="regName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏•‡∏∏‡πâ‡∏ô" class="rounded px-3 py-2 text-black" />
              <button id="btnAdd" class="btn px-4 py-2 rounded bg-[color:var(--gold)] text-black font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <input type="file" id="fileImport" accept=".csv,.txt" class="hidden" />
              <button id="btnImport" class="btn btn-ghost px-3 py-2 rounded">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå</button>
              <button id="btnExport" class="btn btn-ghost px-3 py-2 rounded">Export ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ CSV</button>
              <button id="btnClearAll" class="btn btn-ghost px-3 py-2 rounded">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <p class="text-xs opacity-80">‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤: ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ <span class="show-inline">‡πÄ‡∏•‡∏Ç,‡∏ä‡∏∑‡πà‡∏≠</span> ‡∏´‡∏£‡∏∑‡∏≠ <span class="show-inline">‡πÄ‡∏•‡∏Ç</span> ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πá‡πÑ‡∏î‡πâ</p>
          </div>
          <!-- List -->
          <div id="namesList" class="grid gap-2">
            <div class="flex items-center justify-between gap-2">
              <input id="searchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç" class="rounded px-3 py-2 text-black w-full max-w-sm" />
              <span class="text-sm opacity-80">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="countAll">0</b> ‡∏£‡∏≤‡∏¢</span>
            </div>
            <table class="w-full text-sm bg-white/10 rounded-xl overflow-hidden">
              <thead class="bg-white/20">
                <tr>
                  <th class="text-left p-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç</th>
                  <th class="text-left p-2">‡∏ä‡∏∑‡πà‡∏≠</th>
                  <th class="p-2">‡∏•‡∏ö</th>
                </tr>
              </thead>
              <tbody id="regTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- RESULT MODAL -->
  <div id="resultModal" class="modal-bg">
    <div class="modal p-6">
      <h3 class="text-xl font-bold">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</h3>
      <p class="mt-3">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å: <span id="resNumber" class="text-[color:var(--gold)] font-extrabold text-xl">000000</span></p>
      <div id="resFound" class="mt-2 hidden">
        <p>‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: <span id="resName" class="font-bold"></span></p>
        <p class="text-sm mt-1">‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: <span id="resPrize" class="font-semibold"></span></p>
      </div>
      <div id="resEmpty" class="mt-2 hidden"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p></div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="btnClose" class="px-4 py-2 rounded bg-transparent border border-white/30">‡∏õ‡∏¥‡∏î</button>
        <button id="btnConfirmWin" class="px-4 py-2 rounded bg-[color:var(--gold)] text-black font-semibold hidden">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞</button>
      </div>
    </div>
  </div>

  <!-- PRIZE MODAL -->
  <div id="prizeModal" class="modal-bg">
    <div class="modal p-6">
      <h3 class="text-xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</h3>
      <div id="prizeRows" class="grid gap-2 mt-3"></div>
      <div class="flex gap-2 mt-3">
        <input id="newPrizeName" class="rounded px-3 py-2 text-black flex-1" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÉ‡∏´‡∏°‡πà" />
        <input id="newPrizeQty" type="number" min="1" value="1" class="rounded px-3 py-2 text-black w-24" />
        <button id="addPrize" class="btn px-4 py-2 rounded bg-[color:var(--gold)] text-black font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      </div>
      <div class="flex justify-end gap-2 mt-6">
        <button id="closePrize" class="px-4 py-2 rounded bg-transparent border border-white/30">‡∏õ‡∏¥‡∏î</button>
        <button id="savePrize" class="px-4 py-2 rounded bg-[color:var(--gold)] text-black font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <script>
    // === State ===
    const SKEY='ldraw-6digits-prod.v1';
    const state={
      participants:[],
      winners:[],
      shuffleMs:1200,
      prizes:[{name:'‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',qty:1,active:true}]
    };
    try{Object.assign(state,JSON.parse(localStorage.getItem(SKEY)||'{}'))}catch{}
    const $=id=>document.getElementById(id);
    const onlyDigits=s=>{let out='';const str=String(s);for(let i=0;i<str.length;i++){const c=str[i];if(c>='0'&&c<='9') out+=c;}return out};
    const pad6=n=>onlyDigits(n).padStart(6,'0').slice(-6);
    const save=()=>localStorage.setItem(SKEY,JSON.stringify(state));

    // Tabs (header)
    const show=p=>{ $('panelDraw').classList.toggle('hidden',p!=='draw'); $('panelRegister').classList.toggle('hidden',p!=='register'); $('tabDraw').classList.toggle('bg-[color:var(--gold)]',p==='draw'); $('tabDraw').classList.toggle('text-black',p==='draw'); $('tabRegister').classList.toggle('bg-[color:var(--gold)]',p==='register'); $('tabRegister').classList.toggle('text-black',p==='register'); };
    $('tabDraw').onclick=()=>show('draw'); $('tabRegister').onclick=()=>show('register');

    // Names sub-tabs
    function showNamesTab(k){ const add=$('namesAdd'), list=$('namesList'); const b1=$('tabNamesList'), b2=$('tabNamesAdd'); if(k==='add'){ add.classList.remove('hidden'); list.classList.add('hidden'); b2.classList.add('bg-white/20','font-semibold'); b1.classList.remove('bg-white/20','font-semibold'); } else { list.classList.remove('hidden'); add.classList.add('hidden'); b1.classList.add('bg-white/20','font-semibold'); b2.classList.remove('bg-white/20','font-semibold'); } }
    $('tabNamesList').onclick=()=>showNamesTab('list'); $('tabNamesAdd').onclick=()=>showNamesTab('add');

    // Register rendering/search
    let searchQuery='';
    function renderReg(){
      const tb=$('regTable'); tb.innerHTML='';
      const data=state.participants.filter(p=>!searchQuery||p.name.toLowerCase().includes(searchQuery)||p.num.includes(searchQuery));
      $('countAll').textContent=state.participants.length;
      data.forEach((p)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=\`<td class='p-2'>\${p.num}</td><td class='p-2'>\${p.name||'-'}</td><td class='p-2 text-center'><button data-num='\${p.num}' class='text-xs bg-white/20 px-2 py-1 rounded'>‡∏•‡∏ö</button></td>\`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll('button[data-num]').forEach(b=>b.onclick=e=>{
        const num=e.target.dataset.num; const idx=state.participants.findIndex(x=>x.num===num);
        if(idx>-1){ state.participants.splice(idx,1); save(); renderReg(); }
      });
    }
    $('searchBox').addEventListener('input',e=>{searchQuery=(e.target.value||'').trim().toLowerCase(); renderReg();});

    const genUniqueNumber=()=>{let tries=0;while(tries++<800){const n=String(Math.floor(Math.random()*1e6)).padStart(6,'0');if(!state.participants.some(p=>p.num===n))return n;}return String(Date.now()%1e6).padStart(6,'0')};
    $('regNumber').addEventListener('input',e=>e.target.value=pad6(e.target.value));
    $('btnAdd').onclick=()=>{
      const num=pad6($('regNumber').value),name=$('regName').value.trim();
      if(!num){$('regNumber').focus();return}
      if(state.participants.some(p=>p.num===num)){alert('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß');return}
      state.participants.push({num,name}); $('regNumber').value=''; $('regName').value=''; save(); renderReg(); showNamesTab('list');
    };

    // Import/Export/clear participants
    $('btnImport').onclick=()=>$('fileImport').click();
    $('fileImport').addEventListener('change',async e=>{const f=e.target.files[0]; if(!f) return; const txt=await f.text(); importParticipants(txt); e.target.value='';});
    function importParticipants(text){
      const used=new Set(state.participants.map(p=>p.num));
      const lines=text.split(/\\r?\\n/).map(x=>x.trim()).filter(Boolean); let added=0;
      for(const line of lines){
        const [a,b] = line.split(',');
        const num=pad6(a||'');
        if(!num) continue;
        if(used.has(num)) continue;
        used.add(num);
        state.participants.push({num,name:(b||'').trim()});
        added++;
      }
      save(); renderReg(); alert(\`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: \${added} ‡∏£‡∏≤‡∏¢\`);
    }
    $('btnExport').onclick=()=>{
      const rows=[["number","name"],...state.participants.map(p=>[p.num,p.name])];
      const csv=rows.map(r=>r.map(x=>'"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\\n');
      const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      const a=document.createElement('a'); a.href=url; a.download='participants.csv'; a.click(); URL.revokeObjectURL(url);
    };
    $('btnClearAll').onclick=()=>{if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){state.participants=[]; save(); renderReg();}};

    // Export winners
    $('btnExportWinners').onclick=()=>{
      const rows=[["number","name","prize","timestamp"],...state.winners.map(w=>[w.num,w.name,w.prize,w.ts])];
      const csv=rows.map(r=>r.map(x=>'"'+String(x).replace(/"/g,'""')+'"').join(',')).join('\\n');
      const url=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      const a=document.createElement('a'); a.href=url; a.download='winners.csv'; a.click(); URL.revokeObjectURL(url);
    };

    // Dummy seed (only first time)
    const dummyNames=['David Wilson','Jane Smith','John Doe','Michael Johnson','Sarah Brown','Emily Davis','Chris Miller','Olivia Taylor','Daniel Anderson','Sophia Thomas','‡∏ö‡∏¥‡∏ô‡πÄ‡∏î‡∏ä ‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á','‡∏õ‡∏ì‡∏¥‡∏ä‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏ô‡∏±‡∏Å','‡∏ß‡∏¥‡πÑ‡∏• ‡∏™‡∏ß‡∏¢‡πÉ‡∏™','‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ','‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡πÉ‡∏à‡∏á‡∏≤‡∏°','‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏û‡∏•‡∏±‡∏á‡∏î‡∏µ','‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏ô‡∏Å ‡∏®‡∏£‡∏µ‡∏™‡∏∏‡∏Ç','‡∏≠‡∏ò‡∏¥‡∏ä‡∏≤ ‡∏≠‡∏ô‡∏±‡∏ô‡∏ï‡πå‡∏ä‡∏±‡∏¢','‡∏ä‡∏≤‡∏ç‡∏ä‡∏±‡∏¢ ‡πÉ‡∏à‡∏Å‡∏•‡πâ‡∏≤','‡∏ß‡∏£‡∏£‡∏ì‡∏¥‡∏†‡∏≤ ‡∏û‡∏£‡∏´‡∏°‡∏™‡∏∏‡∏Ç'];
    function ensureDummy(){ if(state.participants.length===0){ const used=new Set(); dummyNames.forEach(n=>{ let num; do{ num=String(Math.floor(Math.random()*1e6)).padStart(6,'0'); }while(used.has(num)); used.add(num); state.participants.push({num,name:n}); }); save(); } }

    // Prizes helpers
    const activePrize=()=>state.prizes.find(p=>p.active)||state.prizes[0];
    const winsOfPrize=name=>state.winners.filter(w=>w.prize===name).length;
    const remain=p=>Math.max(0,(parseInt(p.qty||0)-winsOfPrize(p.name)));
    function updatePrizeViews(){ const p=activePrize(); const rem=p?`${remain(p)}/${p.qty}`:'-'; $('quickRemain').textContent=rem; $('fsPrizeName').textContent=p?p.name:'‚Äî'; $('fsPrizeRemain').textContent=p?`(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${rem})`:''; }
    function buildQuickPrize(){ const sel=$('quickPrize'); sel.innerHTML=''; state.prizes.forEach((p,i)=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=`${p.name} (‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${remain(p)}/${p.qty})`; if(p.active) opt.selected=true; sel.appendChild(opt); }); sel.onchange=()=>{ const i=parseInt(sel.value); state.prizes.forEach((p,idx)=>p.active=(idx===i)); save(); updatePrizeViews(); buildQuickPrize(); }; }

    // Digits utils
    function setDigits(s){for(let i=0;i<6;i++){$('d'+i).textContent=s[i]||'0';}$('drawNumber').textContent=s}
    function readDigits(){let s='';for(let i=0;i<6;i++){s+=($('d'+i).textContent||'0');}return s}
    function pool(){const taken=new Set(state.winners.map(w=>w.num));return state.participants.filter(p=>!taken.has(p.num))}
    function clearLocks(){for(let i=0;i<6;i++)$('d'+i).classList.remove('locked')}
    function revealTo(target, done){ let i=0; const lockNext=()=>{ if(i>=6){ done&&done(); return; } const box=$('d'+i); const final=target[i]; let t0=performance.now(); const dur=300; const tick=(now)=>{ if(now-t0>=dur){ box.textContent=final; box.classList.add('locked'); $('drawNumber').textContent=readDigits(); i++; setTimeout(lockNext,100); return; } box.textContent=String(Math.floor(Math.random()*10)); $('drawNumber').textContent=readDigits(); requestAnimationFrame(tick); }; requestAnimationFrame(tick); }; lockNext(); }

    // Draw
    let raf=0,final=null,person=null;
    $('btnStart').onclick=()=>{
      const p=pool(); if(!p.length){ $('resNumber').textContent='‚Äî‚Äî'; $('resFound').classList.add('hidden'); $('btnConfirmWin').classList.add('hidden'); $('resEmpty').classList.remove('hidden'); $('resultModal').classList.add('show'); return; }
      const ap=activePrize(); if(!ap){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'); return; }
      if(remain(ap)<=0){ alert('‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'); return; }
      const pick=p[Math.floor(Math.random()*p.length)]; final=pick.num; person=pick; clearLocks();
      const start=performance.now(); const spinStep=(now)=>{ if(now-start>=state.shuffleMs){ cancelAnimationFrame(raf); revealTo(final, ()=>{ 
          const isFS = document.body.classList.contains('fs-mode');
          if(isFS){
            const ts=new Date().toLocaleString('th-TH',{hour12:false});
            state.winners.unshift({num:person.num,name:person.name,prize:ap.name,ts});
            save(); paintWinners(); updatePrizeViews(); buildQuickPrize();
          } else {
            $('resNumber').textContent=final; 
            $('resEmpty').classList.add('hidden'); 
            $('resFound').classList.remove('hidden'); 
            $('resName').textContent=(person.name||'-')+' ('+person.num+')'; 
            $('resPrize').textContent=ap.name; 
            $('btnConfirmWin').classList.remove('hidden'); 
            $('resultModal').classList.add('show'); 
          }
        }); return; } if(((now-start)%80)<16){ setDigits(String(Math.floor(Math.random()*1e6)).padStart(6,'0')); } raf=requestAnimationFrame(spinStep); }; raf=requestAnimationFrame(spinStep); };

    // Winners
    $('btnConfirmWin').onclick=()=>{ const ap=activePrize(); const ts=new Date().toLocaleString('th-TH',{hour12:false}); state.winners.unshift({num:person.num,name:person.name,prize:ap.name,ts}); save(); paintWinners(); updatePrizeViews(); buildQuickPrize(); $('btnClose').click() };
    function paintWinners(){ const box=$('winnerList'); box.innerHTML=''; state.winners.forEach(w=>{ const li=document.createElement('li'); li.className='bg-white/10 rounded p-2'; li.innerHTML=`<div class='font-semibold text-[color:var(--gold)]'>${w.num}</div><div class='text-xs'>${w.name||'-'} ‚Ä¢ ${w.prize||''} ‚Ä¢ ${w.ts}</div>`; box.appendChild(li); }); }
    $('btnResetWinners').onclick=()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ state.winners=[]; save(); paintWinners(); updatePrizeViews(); buildQuickPrize(); }};

    // Prize modal
    const prizeModal=$('prizeModal');
    function openPrize(){ buildPrizeRows(); prizeModal.classList.add('show'); }
    function closePrize(){ prizeModal.classList.remove('show'); }
    $('btnManagePrize').onclick=openPrize; $('closePrize').onclick=closePrize; prizeModal.addEventListener('click',e=>{ if(e.target.id==='prizeModal') closePrize(); });
    function buildPrizeRows(){ const wrap=$('prizeRows'); wrap.innerHTML=''; state.prizes.forEach((p,i)=>{ const row=document.createElement('div'); row.className='bg-white/10 rounded p-3 grid grid-cols-[1fr_auto_auto_auto_auto] gap-2 items-center'; row.innerHTML=`<input data-i='${i}' class='pName rounded px-2 py-1 text-black' value='${p.name}'> <span class='text-sm'>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b class='text-[color:var(--gold)]'>${remain(p)}</b> / ${p.qty}</span> <input data-i='${i}' type='number' min='1' class='pQty w-20 rounded px-2 py-1 text-black' value='${p.qty}'> <label class='text-sm flex items-center gap-1'><input data-i='${i}' type='radio' name='activePrize' ${p.active?'checked':''}> ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label> <button data-i='${i}' class='del btn px-3 py-1 rounded btn-ghost'>‡∏•‡∏ö</button>`; wrap.appendChild(row); }); wrap.querySelectorAll('.pName').forEach(inp=>inp.oninput=e=>{const i=+e.target.dataset.i; state.prizes[i].name=e.target.value; save(); updatePrizeViews(); buildQuickPrize();}); wrap.querySelectorAll('.pQty').forEach(inp=>inp.oninput=e=>{const i=+e.target.dataset.i; state.prizes[i].qty=Math.max(1,parseInt(e.target.value||1)); save(); updatePrizeViews(); buildQuickPrize(); buildPrizeRows();}); wrap.querySelectorAll('input[name=activePrize]').forEach((r,idx)=> r.onchange=()=>{ state.prizes.forEach((p,j)=>p.active=(j===idx)); save(); updatePrizeViews(); buildQuickPrize();}); wrap.querySelectorAll('.del').forEach(btn=> btn.onclick=e=>{ const i=+e.target.dataset.i; if(state.prizes.length<=1){alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•'); return} state.prizes.splice(i,1); save(); updatePrizeViews(); buildQuickPrize(); buildPrizeRows(); }); }
    $('addPrize').onclick=()=>{ const name=$('newPrizeName').value.trim(); const qty=Math.max(1,parseInt($('newPrizeQty').value||1)); if(!name){$('newPrizeName').focus(); return} state.prizes.push({name,qty,active:false}); $('newPrizeName').value=''; $('newPrizeQty').value=1; save(); buildPrizeRows(); buildQuickPrize(); updatePrizeViews(); };
    $('savePrize').onclick=()=>{ save(); closePrize(); };

    // Modal base
    $('btnClose').onclick=()=>{$('resultModal').classList.remove('show')};
    $('resultModal').addEventListener('click',e=>{if(e.target.id==='resultModal')$('btnClose').click()});

    // Fullscreen
    function isFS(){return document.fullscreenElement||document.webkitFullscreenElement}
    function reqFS(el){(el.requestFullscreen||el.webkitRequestFullscreen||function(){}).call(el)}
    function exitFS(){(document.exitFullscreen||document.webkitExitFullscreen||function(){}).call(document)}
    function toggleFS(){const el=$('drawStage'); isFS()?exitFS():reqFS(el)}
    $('btnFullscreen').onclick=toggleFS; ['fullscreenchange','webkitfullscreenchange'].forEach(ev=>document.addEventListener(ev,()=>{document.body.classList.toggle('fs-mode',!!isFS()); updatePrizeViews();})); $('drawStage').addEventListener('dblclick',toggleFS);
    document.addEventListener('keydown',e=>{if(e.key==='f'||e.key==='F'){e.preventDefault();toggleFS();} if((e.key===' '||e.code==='Space')&&document.body.classList.contains('fs-mode')){e.preventDefault();$('btnStart').click();}});

    // Init
    ensureDummy(); renderReg(); paintWinners(); setDigits('000000'); show('draw'); buildQuickPrize(); updatePrizeViews(); showNamesTab('list');
  </script>
</body>
</html>
